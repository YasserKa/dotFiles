#!/usr/bin/env bash
# Dependencies: pdm

# Initialize environment and create jupyter notebooks with jupyter_ascending
# https://github.com/untitled-ai/jupyter_ascending
# which uses jupytext to sync sync.py and .sync.ipynb and adding "cell
# execution" cababilities from within the .py file

[[ "$1" == "create" && -z "$2" ]] &&
	echo "Need notebook name as an argument" && exit

if [[ "$1" == "init" ]]; then
	pdm init
	# Use older version, because jupyter nbextension doesn't work on newer version
	pdm add -dG jupyter jupyter_contrib_nbextensions jupyter_ascending editdistance==0.8.1 notebook==6.5.7

	eval "$(pdm venv activate)"
	python -m jupyter nbextension install jupyter_ascending --sys-prefix --py &&
		python -m jupyter nbextension enable jupyter_ascending --sys-prefix --py &&
		python -m jupyter serverextension enable jupyter_ascending --sys-prefix --py
else
	# Create file using jupyter ascending
	python -m jupyter_ascending.scripts.make_pair --base "$2"

	# Remove the top comment block generated by jupyter ascending
	echo "# %%" >|"$2.sync.py"

	# open notebook
	jupyter notebook "$(pwd)/$2.sync.ipynb" &>/dev/null &
	nvim "$(pwd)/$2.sync.py"
fi
