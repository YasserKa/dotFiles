#!/usr/bin/env bash
#
# Toggle org notes
#
# Dependencies: emacs i3/sway xdotool jq

declare -r CLASS="org_notes"

source "$HOME/bin/helpers/monitor_variables"
source "$HOME/.bashrc.d/functions.bash"

# If it's visible, move it to scratchpad
if [[ -n "${WAYLAND_DISPLAY}" ]]; then
	i3-msg -t get_tree |
		jq -e --arg re "^${CLASS}$" '
    recurse(.nodes[]?, .floating_nodes[]?) |
    select(
      ((.name // "") | test($re))
    ) | select(.visible == true)' && swaymsg "[title=^${CLASS}$] fullscreen disable" && swaymsg "[title=^${CLASS}$] move scratchpad" && exit 0
elif [[ -n "${DISPLAY}" ]]; then
	xdotool search --onlyvisible --name "^${CLASS}$" >/dev/null && { i3-msg "[title=^${CLASS}$] move scratchpad" && exit 0; }
fi

# Move frame to workspace on right output, enable fullscreen, and go to heading
declare WORKSPACE
if [[ -n "$MONITOR_RIGHT" ]]; then
	WORKSPACE="$(i3-msg -t get_workspaces | jq -r ".[] | select(.output == \"${MONITOR_RIGHT}\") | .name")"
else
	WORKSPACE="$(i3-msg -t get_workspaces | jq -r ".[] | select(.focused == ""true"") | .name")"
fi
readonly WORKSPACE

# If frame doesn't exist, create it, and go to file
if ! is_window_exists "^${CLASS}$"; then
	emacsclient --socket-name="$EMACS_ORG_SOCKET" --no-wait --eval "(let ((frame (make-frame '((name . \"${CLASS}\") (minibuffer . t))))))"

	wait_window "^${CLASS}$" && i3-msg "[title=^${CLASS}$] move --no-auto-back-and-forth workspace ${WORKSPACE}, fullscreen enable"

	emacsclient --socket-name="$EMACS_ORG_SOCKET" --no-wait --eval "
(let ((frame (seq-find (lambda (frame)
              (string= \"${CLASS}\" (frame-parameter frame 'name)))
              (frame-list))))
  (select-frame-set-input-focus frame)
  (run-at-time \"0.4 sec\" nil #'vertico--exhibit)
  (with-selected-frame frame
  (call-interactively (org-roam-node-find nil \"t_\"))
  ))"
fi

wait_window "^${CLASS}$" && i3-msg "[title=^${CLASS}$] move --no-auto-back-and-forth workspace ${WORKSPACE}, fullscreen enable"

goto_window "^${CLASS}$"

emacsclient --socket-name="$EMACS_ORG_SOCKET" --no-wait --eval "
  (with-current-buffer (window-buffer (selected-window))
  (if (minibufferp) (lambda () (minibuffer-keyboard-quit)))
  (org-overview)
  (consult-org-heading)
  (add-hook 'focus-out-hook (lambda () (vertico-exit)))
  (org-fold-show-subtree)
  )"
