#!/bin/sh
# Description: open mynoise website and press a key (pause, resume, increase/decrease volume)
# Dependencies: xdotool, qutebrowser

URL="https://mynoise.net/NoiseMachines/medievalMinstrelSoundscapeGenerator.php?l=29292929292929292929"

# Class name for the application used by xdotool (used to have one instance open at all time)
CLASS_NAME="ambient_music"

function get_id_ambient () {
    qutebrowser_id=""

    # Check if class name is available
    pid_class_name=$(xdotool search --class $CLASS_NAME)

    if [[ ! -z $pid_class_name ]]; then
        qutebrowser_id=$pid_class_name
    else
        # Check for the dot "•" in the title of page
        pids_qutebrowser=$(xdotool search --class qutebrowser)
        for pid in $pids_qutebrowser; do
            name=$(xdotool getwindowname $pid)
            if [[ $name == *"•"* ]]; then
                sleep 0.1
                qutebrowser_id=$pid
                break
            fi
        done
    fi

    echo $qutebrowser_id
}

# If window doesn't exist it, open it
if [[ -z $(get_id_ambient) ]];  then
    # Open and wait until the website loads
    qutebrowser --target window $URL &
    while [[ -z $(get_id_ambient) ]]; do
        sleep 0.1
    done

    # Assign class name
    xdotool set_window --class "$CLASS_NAME" $(get_id_ambient)
else
    xdotool key --window $(get_id_ambient) $1
fi
