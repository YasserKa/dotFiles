#!/bin/env sh

# General script for note taking
# Used for:
# 1- persistent general notes
# 2- Copy latex notes to clipboard
# 3- org capture note via org protocol
# Dependencies nvim xclip
# org protocol: emacs

EXTENSION="$1"
TEMP_PATH="/tmp/tmp.$EXTENSION"
CLASS="tmp_$EXTENSION"

if [[ -z $(ps aux | grep -v "grep" | grep $CLASS) ]]; then
    $TERMINAL --class "$CLASS" -e $EDITOR -c 'startinsert' $TEMP_PATH &
    while [[ -z $(wmctrl -xl | grep " $CLASS") ]]; do sleep 0.5; done
    i3-msg "[class=\"^$CLASS$\"] scratchpad show, move position center"
else
    pkill -f $CLASS
fi

# Wait until the window exits
while [[ ! -z $(wmctrl -xl | grep " $CLASS") ]]; do sleep 0.5; done

if [[ $EXTENSION == "org_protocol" ]]; then
    cat $TEMP_PATH | xargs -I % emacsclient --no-wait "org-protocol://capture?template=n&title=%"
    [[ $? != 0 ]] && dunstify "Note not captured" "Emacs server isn't running"
else
    cat $TEMP_PATH | xclip -selection clipboard
fi

rm $TEMP_PATH
