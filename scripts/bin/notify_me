#!/usr/bin/env python

import os
import subprocess
from selenium import webdriver
from time import sleep
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.chrome.service import Service
from selenium.common.exceptions import TimeoutException, SessionNotCreatedException, WebDriverException

# used by dunstify/dunst
APP_NAME = 'notify-me'

URL_DISCORD = 'https://discordapp.com/channels/@me'
URL_WHATS_APP = 'https://web.whatsapp.com/'
URL_FACEBOOK = 'https://www.facebook.com/'

executable_path = '/home/yasser/.config/chromium/chromedriver'
profile_path = '/home/yasser/.config/chromium/notify_me_profile'

discord = ' Discord'
facebook = ' Facebook'
reddit = ' Reddit'
whatsapp = 'Whatsapp'

driver = None


def check_discord():

    driver.get(URL_DISCORD)
    WebDriverWait(driver, 10).until(
        lambda x: len(x.find_elements(By.XPATH, './/*[contains(text(), "Friends")]')) > 0)
    sleep(1)

    notificaitons_el = driver.find_elements(
        By.CSS_SELECTOR, 'div[class*=lowerBadge-]')

    discord_servers = driver.find_elements(
        By.XPATH, './/div[contains(@aria-label, "Servers")]/*/div/span[contains(@class, "item")]')

    notificaiton_exists = len(notificaitons_el) > 0 or len(discord_servers) > 0

    if notificaiton_exists:
        send_notification(discord, URL_DISCORD)

def send_notification(notification_text, url):
    subprocess.run(f"[[ $(dunstify '{notification_text}' --appname={APP_NAME}"
            f" --action='action,label') == 'action' ]] && qutebrowser {url}"
            , shell=True, text=True, check=True)

def check_facebook():
    driver.get(URL_FACEBOOK)
    WebDriverWait(driver, 5).until(
            lambda x: len(x.find_elements(By.XPATH, 
                './/div[contains(@aria-label, "Messenger")]')) > 0)

    notificaitons_el = driver.find_elements(
            By.XPATH, './/div[contains(@aria-label, "Messenger")]//child::span[1][(text()=number())]')

    notificaiton_exists = len(notificaitons_el) > 0

    if notificaiton_exists:
        send_notification(facebook, URL_FACEBOOK)


def check_whatsapp():
    driver.get(URL_WHATS_APP)
    WebDriverWait(driver, 20).until(
            lambda x: len(x.find_elements(By.XPATH, 
                './/*[contains(text(),"Search or start new chat")]')) > 0)

    unread_messages = driver.find_elements(
            By.XPATH, './/*[contains(@aria-label,"unread message")]')

    unread_messages_exist = len(unread_messages) > 0

    if unread_messages_exist:
        send_notification(whatsapp, URL_WHATS_APP)


def main():
    global driver

    options = webdriver.ChromeOptions()
    options.add_argument('user-data-dir=' + profile_path)
    os.system("pkill chromedriver")
    driver = webdriver.Chrome(service=Service(executable_path=executable_path), options=options)

    try:
        check_discord()
        check_facebook()
        check_whatsapp()
    except TimeoutException:
        pass

    driver.close()
    os.system("pkill chromedriver")


if __name__ == '__main__':
    try:
        main()
    except SessionNotCreatedException:
        subprocess.run(
                "dunstify 'Maybe need a new chromium version'", shell=True)
    except  WebDriverException:
        pass
