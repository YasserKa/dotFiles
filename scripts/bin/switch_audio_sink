#!/usr/bin/env bash

# Switch Input audio sink between built in, displaylink (universal docking station) & bluetooth

# For notification server
APP_NAME="switch-sink"
# Earphones mac address
DEVICE="6C:D3:EE:04:51:E2"

PICKED_SINK="$1"
case $PICKED_SINK in
	"Bluetooth")
		Name="bluez_output"
		icon="bluetooth-64"

		rfkill unblock bluetooth

		# Wait until the device is connected
		while sleep 1; do
			grep -nE "Connected: yes" <(echo -e "info $DEVICE" | bluetoothctl) && break
			echo -e "connect $DEVICE" | bluetoothctl
		done
		;;
	"Built In")
		icon="laptop-sound-64"
		Name="pci"
		rfkill block bluetooth
		;;
	"DisplayLink")
		icon="earbud-sound-64"
		Name="DisplayLink"
		rfkill block bluetooth
		;;
	*) notify-send --app-name=$APP_NAME --expire-time=1000 "Couldn't find the $PICKED_SINK sink" && exit 1 ;;
esac

# It takes sometime for bluetooth sink to be available
while sleep 1; do
	NEW_SINK=$(pactl list sinks | grep -nE "Name.*$Name" | cut -d : -f 3- | xargs)
	[[ -n "$NEW_SINK" ]] && break
done

notify-send --app-name=$APP_NAME --expire-time=1000 --icon="$icon" "Switching to $PICKED_SINK sink"
pactl set-default-sink "$NEW_SINK"
