#!/usr/bin/env bash
#
# Send command to a reusable kitty process and wait until its done
#
# kitty_control init      ; open kitty terminal & exit
# kitty_control <cmd> [-g]; run <cmd> in terminal
# Arguments:
# (optional) -g --geometry kitty window's geometry (added to floating enable, scratchpad show)
#
# Dependencies: kitty i3/sway clipboard_copy clipboard_paste

declare -r SOCKET_ADDRESS="unix:/tmp/kitty.socket"
declare -r CLASS="terminal_scratch"
declare LOCK_FILE
LOCK_FILE="/tmp/kitty_control.lock"
readonly LOCK_FILE
declare GEOMETRY="move position center, resize set 990 820, move up 145 px"

# shellcheck disable=SC1091
source "$HOME/.bashrc.d/functions.bash"

main() {
	while [[ $# -gt 0 ]]; do
		case $1 in
			-g | --geometry)
				GEOMETRY="$2"
				shift
				shift
				;;
			init)
				is_window_exists "${CLASS}" || kitty --title "${CLASS}" --listen-on="$SOCKET_ADDRESS" --detach && exit 0
				;;
			*)
				cmd="$1"
				shift
				;;
		esac
	done
	readonly GEOMETRY

	# Use a lockfile to wait until the process is finished
	touch "$LOCK_FILE"

	show_kitty
	send_cmd "$cmd"

	i3-msg "[title=\"^${CLASS}$\"] scratchpad show, floating enable,  $GEOMETRY" >/dev/null

	while [[ -f "$LOCK_FILE" ]]; do
		sleep 0.1
	done
}

#######################################
# Send command to remote kitty process
# Globals:
#   SOCKET_ADDRESS
#   CLASS
#   LOCK_FILE
# Arguments:
#   $*
#######################################
send_cmd() {
	src_file="/tmp/kitty_control_src_file"

	trap 'rm $src_file; unset src_file' EXIT

	# NOTE: Wayland needs fullscreen disabled; otherwise, it bugs out when other windows are fullscreened
	if [[ -n "${WAYLAND_DISPLAY}" ]]; then
		printf "%s\n%s\n%s" "$*" "swaymsg '[title=^${CLASS}$] fullscreen disable' && swaymsg '[title=^${CLASS}$] move scratchpad'" "rm -f $LOCK_FILE" >|"$src_file"
	elif [[ -n "${DISPLAY}" ]]; then
		printf "%s\n%s\n%s" "$*" "i3-msg '[title=\"^${CLASS}$\"] move scratchpad'" "rm -f $LOCK_FILE" >|"$src_file"
	fi

	kitty @ --to "$SOCKET_ADDRESS" action paste "< $src_file bash"
	kitty @ --to "$SOCKET_ADDRESS" send-key 'ctrl+m'
	sleep 0.07 # Sleep to not show the actions above
}

show_kitty() {
	is_window_exists "${CLASS}" >/dev/null || {
		kitty --title "${CLASS}" --listen-on="$SOCKET_ADDRESS" --detach && wait_window "${CLASS}" && sleep 0.15
	}
}

main "$@"
