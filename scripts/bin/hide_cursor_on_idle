#!/usr/bin/env bash

TIMEOUT=3

STATEFILE_ACTIVITY="/tmp/cursor_last_activity"
STATEFILE_STATE="/tmp/cursor_state"
date +%s >|"$STATEFILE_ACTIVITY"
echo "false" >|"$STATEFILE_STATE"

# Background process to check timeout
(
	while true; do
		last_activity=$(cat "$STATEFILE_ACTIVITY" 2>/dev/null || echo 0)
		cursor_hidden=$(cat "$STATEFILE_STATE" 2>/dev/null || echo 0)
		current_time=$(date +%s)

		if [[ $((current_time - last_activity)) -gt $TIMEOUT ]] && [[ "$cursor_hidden" = "false" ]]; then
			swaymsg seat seat0 xcursor_theme "transparent"
			echo "true" >|"$STATEFILE_STATE"
		fi

		sleep 0.5
	done
) &

# Monitor mouse movement
libinput debug-events | while read -r line; do
	if echo "$line" | grep -q "POINTER_MOTION"; then
		cursor_hidden=$(cat "$STATEFILE_STATE" 2>/dev/null || echo 0)

		date +%s >|"$STATEFILE_ACTIVITY"
		if [[ "$cursor_hidden" == "true" ]]; then
			swaymsg seat seat0 xcursor_theme default
			echo "false" >|"$STATEFILE_STATE"
		fi
	fi
done
