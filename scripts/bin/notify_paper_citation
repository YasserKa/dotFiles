#!/usr/bin/env bash
# Send notification about # citations and # influential citations
#
# $1: paper URL
#
# Dependencies: notify-send, jq, semanticscholar api key

# With more details
main() {
	local URL="$1"
	local response citations influential

	DOI="$("$XDG_CONFIG_HOME/Zotero/bin/zotero_utility" get_metadata DOI "$URL")"
	response=$(curl -H "x-api-key: $(pass semantic_scholar_api_key)" "https://api.semanticscholar.org/graph/v1/paper/DOI:${DOI}?fields=citationCount,influentialCitationCount")

	# DOI, didn't work, use title
	if echo "$response" | jq -e 'has("error")' >/dev/null; then
		dunstify "Couldn't find paper using DOI, trying with title"
		sleep 1.5 # Rate limit
		TITLE="$("$XDG_CONFIG_HOME/Zotero/bin/zotero_utility" get_metadata title "$URL")"
		ENCODED_TITLE="$(echo "$TITLE" | jq -Rr '@uri')"
		response="$(curl -H "x-api-key: $(pass semantic_scholar_api_key)" "https://api.semanticscholar.org/graph/v1/paper/search/match?query=${ENCODED_TITLE}&fields=citationCount,influentialCitationCount")"
		[[ "$(echo "$response" | jq -r '.data | length')" != 1 ]] && echo dunstify "Note: more than paper identified"
		# Get first paper
		response="$(echo "$response" | jq -r '.data[0]')"
	fi

	citations=$(echo "$response" | jq -r '.citationCount')
	influential=$(echo "$response" | jq -r '.influentialCitationCount')

	if [[ "$citations" != "null" ]]; then
		notify-send --expire-time 10000 "Paper Stats" "üìä Citations: $citations\n‚≠ê Influential: $influential"
	else
		notify-send "Error" "Could not fetch data for: $TITLE"
	fi
}

main "$@"
