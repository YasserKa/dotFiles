# man 5 sway
# vim:nospell:foldmarker=<<<,>>>:foldmethod=marker
# General <<<
set $mod Mod4
gaps inner 2
gaps outer 2

# Set window borders
default_border pixel 3
default_border none
default_floating_border none

# Swayfx settings
default_dim_inactive 0.2
blur enable
# Blur background floating windows
blur_xray enable

font pango:Inconsolata 14

xwayland disable

# >>>
# Workspaces/Windows <<<
# Focus windows
bindsym $mod+j  focus down
bindsym $mod+k  focus up
bindsym $mod+l  focus right
bindsym $mod+h  focus left

# Move focused windows
bindsym $mod+Shift+j move down
bindsym $mod+Shift+k move up
bindsym $mod+Shift+l move right
bindsym $mod+Shift+h move left

# Split in hor/vert orientation
bindsym $mod+v split horizontal
bindsym $mod+Shift+v split vertical

bindsym $mod+z workspace back_and_forth
bindsym $mod+Shift+minus move scratchpad

# Make the current focus fullscreen
bindsym $mod+f fullscreen toggle; focus

# Toggle the current focus between tiling and floating mode
bindsym $mod+Shift+space floating toggle

# Drag/resize floating with mouse left/right+$mod
floating_modifier $mod normal

# Swap focus between the tiling area and the floating area
bindsym $mod+space focus mode_toggle

# Worspaces
set $browser 1
set $coding 2
set $notes 3
set $git 4
set $video 5
set $wp6 6
set $social 7
set $documents 8
set $wp9 9
set $wp0 0

output * bg $HOME/Pictures/WallPapers/763859.jpg fill

# Manage output configuration dynamically
# exec bash -ic 'killall shikane; shikane & disown'
# Create file to avoid infinite shikane reload
# Reload waybar (Needs to be after shikane reload && it needs bash to source the monitors properly)
exec_always touch /tmp/flag_sway_reloaded && shikane --oneshot && bash -ic 'killall -9q waybar; source $HOME/bin/helpers/monitor_variables && envsubst < $XDG_CONFIG_HOME/waybar/config_template.jsonc >| $XDG_CONFIG_HOME/waybar/config.jsonc && waybar & disown'

include ~/.config/i3/monitor_setup

bindsym $mod+1 workspace $browser
bindsym $mod+2 workspace $coding
bindsym $mod+3 workspace $notes
bindsym $mod+4 workspace $git
bindsym $mod+5 workspace $video
bindsym $mod+6 workspace $wp6
bindsym $mod+7 workspace $social
bindsym $mod+8 workspace $documents
bindsym $mod+9 workspace $wp9
bindsym $mod+0 workspace $wp0

# Move focused container to workspace
bindsym $mod+Shift+1 move container to workspace $browser
bindsym $mod+Shift+2 move container to workspace $coding
bindsym $mod+Shift+3 move container to workspace $notes
bindsym $mod+Shift+4 move container to workspace $git
bindsym $mod+Shift+5 move container to workspace $video
bindsym $mod+Shift+6 move container to workspace $wp6
bindsym $mod+Shift+7 move container to workspace $social
bindsym $mod+Shift+8 move container to workspace $documents
bindsym $mod+Shift+9 move container to workspace $wp9
bindsym $mod+Shift+0 move container to workspace $wp0
bindsym $mod+Shift+z move container to workspace back_and_forth

# Go back and forth
workspace_auto_back_and_forth yes

# Opening softwares to a default workspaces
# Use `swaymsg -t get_tree` to check window attributes
assign [title="^emacs_org$"] workspace $notes
assign [title="^emacs_magit$"] workspace $git
assign [app_id="Slack"] workspace $social
assign [app_id="org.pwmt.zathura"] workspace $documents

# For notify_me script
for_window [instance="notify_me_profile"] move scratchpad

# Making softwares in floating mode
for_window [class="Vlc|feh|Shutter"] floating enable
for_window [app_id="imv|mpv"] floating enable

# Enable floating for windows that has floating class
for_window [instance="floating"] floating enable

for_window [title="^fullscreen$"] fullscreen enable

for_window [instance="pinentry-gtk"] floating enable

# Capture a note using org mode
for_window [title="^org-capture-yeq$"] floating enable, move position center

# Make it none at start, so startup programs don't get focused
exec swaymsg focus_on_window_activation none && sleep 5 && swaymsg focus_on_window_activation smart

# Sway in Wayland doesn't focus windows; this makes it possible
exec [[ -z $DISPLAY ]] && swaymsg -mt subscribe '["window"]' | jq --unbuffered 'select(.change == "urgent").container.id' | xargs -I{} swaymsg '[con_id={} urgent=latest]' focus &>/dev/null &
# >>>
# Modes <<<
bindsym $mod+r mode "resize"
mode "resize" {
    bindsym h resize shrink width 10 px or 10 ppt;
    bindsym j resize grow height 10 px or 10 ppt;
    bindsym k resize shrink height 10 px or 10 ppt;
    bindsym l resize grow width 10 px or 10 ppt;

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

# Emacs org clock
set $clock_mode "clock (I)nfo, (i)n, (o)ut, (d)one, (c)ancel, (t)oggle, (g)o_to, (s)cheduled, (p)olybar"
bindsym $mod+q mode $clock_mode

mode $clock_mode {
    bindsym i exec $XDG_CONFIG_HOME/emacs/bin/org_clock clock_in; mode "default";
    bindsym shift+i exec $XDG_CONFIG_HOME/emacs/bin/org_clock \
        notify_info "NAME_PLACEHOLDER\n[TIME_PLACEHOLDER]"; mode "default";
    bindsym o exec $XDG_CONFIG_HOME/emacs/bin/org_clock clock_out; mode "default";
    bindsym d exec $XDG_CONFIG_HOME/emacs/bin/org_clock clock_out_done; mode "default";
    bindsym c exec $XDG_CONFIG_HOME/emacs/bin/org_clock clock_cancel; mode "default";
    bindsym t exec $XDG_CONFIG_HOME/emacs/bin/org_clock clock_toggle; mode "default";
    bindsym p exec $XDG_CONFIG_HOME/emacs/bin/org_clock toggle_bar_time; mode "default";
    bindsym g exec $XDG_CONFIG_HOME/emacs/bin/org_clock go_to_entry; mode "default";
    bindsym s exec $XDG_CONFIG_HOME/emacs/bin/org_clock go_to_scheduled_entry; mode "default";

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

# Music player
# (f)ilter option means that it resets the (c)lassic filter done
set $cmus_mode "(i)nfo, (t)oggle, (n)next, (p)revious, (h)igher, (l)ower, (b)rown noise, (c)hill, (C)lassic, (a)mbient, (A)nime, (d)efault"
bindsym $mod+c mode $cmus_mode
mode $cmus_mode {
    bindsym i exec --no-startup-id $XDG_CONFIG_HOME/cmus/bin/cmus_notification; mode "default";
    bindsym t exec cmus-remote --pause; mode "default";

    bindsym n exec --no-startup-id cmus-remote --next; mode "default";
    bindsym p exec --no-startup-id cmus-remote --prev; mode "default";

    bindsym b exec $XDG_CONFIG_HOME/cmus/bin/cmus_queue --volume 70% "$HOME/Music/brown_noise.mp3"; mode "default";
    bindsym c exec $XDG_CONFIG_HOME/cmus/bin/cmus_queue --volume 40% "$XDG_CONFIG_HOME/cmus/playlists/chill.m3u"; mode "default";
    bindsym shift+c exec $XDG_CONFIG_HOME/cmus/bin/cmus_queue --volume 40% "$XDG_CONFIG_HOME/cmus/playlists/classic.m3u"; mode "default";
    bindsym d exec $XDG_CONFIG_HOME/cmus/bin/cmus_queue "$XDG_CONFIG_HOME/cmus/playlists/default.m3u"; mode "default";
    bindsym shift+a exec $XDG_CONFIG_HOME/cmus/bin/cmus_queue --volume 40% "$HOME/Music/Anime"; mode "default";

    bindsym a exec $XDG_CONFIG_HOME/cmus/bin/cmus_queue --volume 35% --file $HOME/Music/ambient_music.opus; mode "default";

    bindsym h exec --no-startup-id cmus-remote --volume +2%;
    bindsym l exec --no-startup-id cmus-remote --volume -2%;

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

set $sharing_mode "(i)mage, (c)lipboard, (d)rag/drop, (l)atex, (v)ideo, (t)ext, (n)ote"
bindsym $mod+s mode $sharing_mode
mode $sharing_mode {
    bindsym i exec --no-startup-id share -i; mode "default";
    bindsym l exec --no-startup-id share -l; mode "default";
    bindsym c exec --no-startup-id share -c; mode "default";
    bindsym d exec --no-startup-id share -d; mode "default";
    bindsym v exec --no-startup-id share -v; mode "default";
    bindsym t exec --no-startup-id share -t; mode "default";
    bindsym n exec --no-startup-id share -n; mode "default";

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

set $audio_mode "built (i)n, (e)arphones, (h)eadpones, (d)isplay Link"
bindsym $mod+a mode $audio_mode
mode $audio_mode {
    bindsym i exec --no-startup-id switch_audio_sink "Built In"; mode "default";
    bindsym e exec --no-startup-id switch_audio_sink "Bluetooth" "earphones"; mode "default";
    bindsym h exec --no-startup-id switch_audio_sink "Bluetooth" "headphones"; mode "default";
    bindsym d exec --no-startup-id switch_audio_sink "DisplayLink"; mode "default";

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

set $utility_mode "(b)luetooth, (d)ictionary, (l)ights off, (n)otifications, (t)ranslate, (u)nmount usb, (m)ount usb, (v)pn"
bindsym $mod+u mode $utility_mode
mode --pango_markup $utility_mode {
    bindsym b exec --no-startup-id toggle_bluetooth; mode "default";
    bindsym d exec --no-startup-id search_dictionary; mode "default";
# Switch off light
    bindsym l exec --no-startup-id turn_lights_off; mode "default";

    bindsym n exec --no-startup-id dunstctl set-paused toggle; mode "default";

    bindsym t mode $translate_mode;

# Unmount all storage devices;
    bindsym u exec --no-startup-id udiskie-umount -a; mode "default";
    bindsym m exec --no-startup-id udiskie-mount -a; mode "default";

    bindsym v exec --no-startup-id bash -ic "vpn_toggle"; mode "default";

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

set $translate_mode "(p)df, (c)lipboard"
mode $translate_mode {
    bindsym p exec --no-startup-id translate --pdf; mode "default";
    bindsym c exec --no-startup-id translate -c; mode "default";

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

set $mail_mode "(o)pen, (s)ync, (c)lear"
bindsym $mod+m mode $mail_mode
mode $mail_mode {
    bindsym o exec --no-startup-id eval_interactive_cmd neomutt; mode "default";
    bindsym s exec --no-startup-id bash -ic "syncmail" & $XDG_CONFIG_HOME/thunderbird/thunderbird_utility sync; mode "default";
    bindsym c exec --no-startup-id bash -ic '{ $XDG_CONFIG_HOME/neomutt/bin/move_new_mail_to_cur && pkill -RTMIN+8 waybar; } & $XDG_CONFIG_HOME/thunderbird/thunderbird_utility clear && dunstctl close'; mode "default";
    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default";
}

set $system_mode "system (l) lock, (e) logout, (s) reload, (Shift+r) reboot, (Shift+s) shutdown"
bindsym $mod+x mode $system_mode
mode $system_mode {
    bindsym l exec swaylock --color 000000, mode "default";
    bindsym e exec swaymsg exit, mode "default";
    bindsym s exec swaymsg reload, mode "default";

    bindsym Shift+r exec bash -ic reboot, mode "default";
    bindsym Shift+s exec bash -ic shutdown, mode "default";

    bindsym Control+bracketleft mode "default";
    bindsym Escape mode "default"
}
# >>>
# Key Bindings <<<
# Doesn't work in swhkd
# Mulimedia controls
bindsym XF86AudioLowerVolume exec pactl set-sink-volume @DEFAULT_SINK@ -1000
bindsym XF86AudioRaiseVolume exec pactl set-sink-volume @DEFAULT_SINK@ +1000
bindsym XF86MonBrightnessUp exec brightnessctl set 5%+
bindsym XF86MonBrightnessDown exec brightnessctl set 5%-
bindsym XF86AudioMute exec pactl set-sink-mute @DEFAULT_SINK@ toggle
# Prioritize mpv on music player
bindsym XF86AudioPlay exec &>/dev/null { pgrep mpv && echo 'set pause no' | socat - /tmp/mpv-socket } || playerctl play
bindsym XF86AudioPause exec &>/dev/null { pgrep mpv && echo 'set pause yes' | socat - /tmp/mpv-socket }  || playerctl pause
bindsym XF86AudioNext exec &>/dev/null { pgrep mpv && echo 'next' | socat - /tmp/mpv-socket } || playerctl next
bindsym XF86AudioPrev exec &>/dev/null { pgrep mpv && echo 'previous' | socat - /tmp/mpv-socket } || playerctl previous

bindsym XF86AudioForward exec playerctl position "1+"
bindsym XF86AudioRewind exec playerctl position "1-"
bindsym XF86AudioMicMute exec pactl set-source-mute @DEFAULT_SOURCE@ toggle
# ZMK doesn't have have XF86AudioMicMute, so this is used instead
bindsym XF86Phone exec pactl set-source-mute @DEFAULT_SOURCE@ toggle


bindsym $mod+g exec --no-startup-id $TERMINAL
bindsym $mod+Shift+q exec --no-startup-id $XDG_CONFIG_HOME/i3/kill_or_toggle_window
bindsym $mod+d exec --no-startup-id rofi -show run

# Rofi applications
# Password
bindsym $mod+p exec --no-startup-id $XDG_CONFIG_HOME/rofi/bwmenu
# Tmux
bindsym $mod+t exec --no-startup-id $XDG_CONFIG_HOME/rofi/rofi_tmux
# Documents
bindsym $mod+Shift+d exec --no-startup-id fdoc
# Papers
bindsym $mod+Shift+p exec --no-startup-id $XDG_CONFIG_HOME/Zotero/bin/zotero_utility search

# Don't show general notes
bindsym $mod+n exec --no-startup-id $XDG_CONFIG_HOME/emacs/bin/toggle_org_notes

# Show any window besides these
bindsym $mod+minus exec $XDG_CONFIG_HOME/sway/show_scratchpad

for_window [title="^terminal_scratch$"] move scratchpad

for_window [app_id="^bitwarden_editor$"] floating enable, resize set 990 820, move position center

# note taking
bindsym $mod+Shift+n exec --no-startup-id $HOME/bin/create_note "tex"

for_window [title="^tmp_"] move scratchpad, floating enable, move position center, resize set 800 400
# >>>
# Startup <<<
exec --no-startup-id autotiling --limit 2 -e WINDOW_FOCUS -sr 1.61

# Cron environment
exec cat <(cat ~/.config/cron/cron_env_template) <(echo "$(declare -p DISPLAY WAYLAND_DISPLAY)") >| ~/.cache/cron_env

# Applications
# Synchronize files before opening browser
exec --no-startup-id bash -ic 'pull_files_from_remote && inotifywait --timeout 5 -e close_write --format "%w%f" $HOME/.dotfiles-private/qutebrowser/.local/share/qutebrowser/history.sqlite; ${BROWSER} --override-restore'
# Move qutebrowser to fist workspace
exec --no-startup-id bash -ic '{ wait_window "^org.qutebrowser.qutebrowser$" 999 && sleep 0.5 && i3-msg "$(window_get_condition "^org.qutebrowser.qutebrowser$")" move container to workspace 1; }'

for_window [app_id="org.mozilla.Thunderbird" title="Mozilla Thunderbird$"] move scratchpad

exec --no-startup-id sleep 1 && thunderbird & sleep 5 && $XDG_CONFIG_HOME/thunderbird/thunderbird_utility sync
exec --no-startup-id sleep 2 && birdtray

# Manages some key bindings
# Clipboard manager
for_window [title="^CopyQ$"] move scratchpad
# xcb is needed to make global keybindings work in Xwayland
exec --no-startup-id copyq & disown && copyq hide

# In Wayland, dunst doesn't follow focus, use the middle monitor instead
exec --no-startup-id [[ -n "$WAYLAND_DISPLAY" ]] && [[ -z "$DISPLAY" ]] && $XDG_CONFIG_HOME/dunst/update_monitor_id

exec --no-startup-id emacs --bg-daemon=$EMACS_DEFAULT_SOCKET &
# Synchronize notes
exec --no-startup-id bash -ic "org"

exec --no-startup-id kitty_control init

# Manages other devices
exec /bin/kdeconnectd & disown

exec gammastep

# Disable bluetooth
exec rfkill block bluetooth

# Move cursor to middle of screen
exec swaymsg seat - cursor set $(swaymsg -t get_outputs -r \
  | jq -r '.[] | select(.focused) | "\(.rect.x + .rect.width/2) \(.rect.y + .rect.height/2)"')

# Hide cursor & move to center of container
mouse_warping container
exec hide_cursor_on_idle
exec_always [[ "$(cat /tmp/cursor_state)" == "true" ]] && swaymsg seat seat0 xcursor_theme "transparent"


exec --no-startup-id $HOME/bin/helpers/import_systemd_environments && systemctl --user start sway-session.target && gpgconf --kill gpg-agent && gpgconf --launch gpg-agent

include /etc/sway/config.d/*
include $XDG_CONFIG_HOME/i3/config_override
# >>>
