#!/usr/bin/env bash

LIB_LINK="https://libgen.li/index.php"
# sed expression generated by chatGPT
# This will include the first and last (if exists) authors only

ISBN="$(pup --charset utf-8 --file "$QUTE_HTML" ':parent-of(:parent-of(:contains("ISBN"))) :last-child text{}')"
ISBN="$(echo "${ISBN//-}" | grep '^[0-9]\+$' | head -n 1)"

AUTHORS="$(pup --charset utf-8 --file "$QUTE_HTML" ".author.notFaded text{}" | sed -e ':a;N;$!ba;s/\n\s*(.*),\s*/\ /g' -e 's/^\s*//g' -e 's/\s*(.*)//g' -e 's/\s*$//')"
AUTHORS="${AUTHORS%Format*}"
# Replace "&" with "and"
TITLE="$(pup --file "$QUTE_HTML" "#productTitle text{}" | sed -r "s/&amp;/and/g")"

if [[ $ISBN ]]; then
  LINK="$LIB_LINK?req=${ISBN}&order=year&ordermode=desc&covers=on"
else
  LINK="$LIB_LINK?req=${TITLE:2}+${AUTHORS}&order=year&ordermode=desc&covers=on"
fi

echo "open -w $LINK" >>"$QUTE_FIFO"
